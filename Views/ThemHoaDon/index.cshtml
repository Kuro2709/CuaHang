@model CuaHang.Models.ThongTinHoaDon

@{
    ViewBag.Title = "Thêm hóa đơn mới";
}

<h2>Thêm hóa đơn mới</h2>

@if (!string.IsNullOrEmpty(TempData["SuccessMessage"] as string))
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

@using (Html.BeginForm("Index", "ThemHoaDon", FormMethod.Post, new { @id = "invoiceForm" }))
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group">
            @Html.Label("Mã hóa đơn", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.InvoiceID, new { htmlAttributes = new { @class = "form-control", @id = "InvoiceID" } })
                @Html.ValidationMessageFor(model => model.InvoiceID, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.CustomerID, "Khách hàng", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.DropDownListFor(model => model.CustomerID, (SelectList)ViewBag.Customers, "Chọn khách hàng", new { @class = "form-control customer-dropdown small-dropdown" })
                @Html.ValidationMessageFor(model => model.CustomerID, "", new { @class = "text-danger" })
                @Html.Hidden("SelectedCustomerID", Model.CustomerID)
            </div>
        </div>

        <div class="form-group">
            @Html.Label("Ngày tạo hóa đơn", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.InvoiceDate, new { htmlAttributes = new { @class = "form-control kendo-datepicker" } })
                @Html.ValidationMessageFor(model => model.InvoiceDate, "", new { @class = "text-danger" })
            </div>
        </div>

        <h4>Chi tiết sản phẩm</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Tổng giá</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="invoiceDetails">
                @{
                    var InvoiceDetailsList = Model.InvoiceDetails.ToList();
                    for (int i = 0; i < InvoiceDetailsList.Count; i++)
                    {
                        ViewBag.Index = i;
                        @Html.Partial("_InvoiceDetailRow", InvoiceDetailsList[i])
                    }
                }
            </tbody>
        </table>
        <button type="button" class="btn btn-success" id="addDetailRow">Thêm sản phẩm</button>

        <div class="form-group">
            <label class="control-label col-md-2">Tổng tiền</label>
            <div class="col-md-10">
                <input type="text" id="TotalPrice" class="form-control" readonly value="0.00" />
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Nhập tiếp" class="btn btn-primary" />
                <a href="@Url.Action("Index", "HoaDon")" class="btn btn-secondary">Quay lại</a>
            </div>
        </div>
    </div>
}

<style>
    .small-dropdown {
        width: 20%;
    }
</style>

<script>
    $(document).ready(function () {
        // Initialize Kendo UI components
        initializeKendoComponents();

        // Add new detail row
        $('#addDetailRow').click(function () {
            $.ajax({
                url: '@Url.Action("AddInvoiceDetail")',
                type: 'POST',
                success: function (data) {
                    $('#invoiceDetails').append(data);
                    updateRowNames();
                    initializeKendoComponentsForNewRow(); // Initialize Kendo UI components only for the new row
                }
            });
        });

        // Remove detail row
        $(document).on('click', '.remove-row', function () {
            $(this).closest('tr').remove();
            updateTotalPrice(); // Recalculate total price after removing a row
            updateRowNames(); // Update row names after removing a row
        });

        // Update product price and total price
        $(document).on('change', '.product-dropdown', function () {
            var productID = $(this).val();
            var $row = $(this).closest('.invoice-detail-row');
            if (productID) {
                if (isProductDuplicate(productID, $row)) {
                    alert("Sản phẩm này đã được chọn. Vui lòng chọn sản phẩm khác.");
                    $(this).data("kendoDropDownList").value(""); // Reset the dropdown value
                    return;
                }
                $.ajax({
                    url: '@Url.Action("GetProductPriceByID", "ThemHoaDon")',
                    type: 'GET',
                    data: { productID },
                    success: function (price) {
                        $row.find('.unitPrice').val(price);
                        updateRowPrice($row);
                    }
                });
            }
        });

        // Update row price and total price when quantity changes
        $(document).on('input', '.quantity', function () {
            var $row = $(this).closest('.invoice-detail-row');
            var quantity = parseFloat($(this).val()) || 0;
            if (quantity <= 0) {
                $(this).val(1); // Reset to 1 if the quantity is less than or equal to 0
            }
            updateRowPrice($row);
        });

        // Function to update row price
        function updateRowPrice($row) {
            var quantity = parseFloat($row.find('.quantity').val()) || 0;
            var unitPrice = parseFloat($row.find('.unitPrice').val()) || 0;
            var totalPrice = quantity * unitPrice;
            $row.find('.totalPrice').text(totalPrice.toFixed(2));
            updateTotalPrice();
        }

        // Function to calculate and update total price
        function updateTotalPrice() {
            var total = 0;
            $('#invoiceDetails .invoice-detail-row').each(function () {
                var rowTotal = parseFloat($(this).find('.totalPrice').text()) || 0;
                total += rowTotal;
            });
            $('#TotalPrice').val(total.toFixed(2));
        }

        // Function to update row names
        function updateRowNames() {
            $('#invoiceDetails .invoice-detail-row').each(function (index) {
                $(this).find('input, select').each(function () {
                    var name = $(this).attr('name');
                    if (name) {
                        var newName = name.replace(/\[\d+\]/, '[' + index + ']');
                        $(this).attr('name', newName);
                    }
                });
            });
        }

        // Function to check for duplicate products
        function isProductDuplicate(productID, currentRow) {
            var isDuplicate = false;
            $('#invoiceDetails .product-dropdown').each(function () {
                if ($(this).closest('.invoice-detail-row')[0] !== currentRow[0] && $(this).val() === productID) {
                    isDuplicate = true;
                    return false; // Break the loop
                }
            });
            return isDuplicate;
        }

        // Reset the form and clear table rows except for the first
        $('#resetForm').click(function () {
            $('#invoiceDetails').empty();
            $('#TotalPrice').val('0.00');
            $('#addDetailRow').trigger('click'); // Add a single row after reset
        });

        // Initial call to update row names
        updateRowNames();

        // Function to initialize Kendo UI components
        function initializeKendoComponents() {
            // Store the selected value of the customer dropdown
            var selectedCustomerID = $(".customer-dropdown").val();

            // Destroy existing Kendo UI components
            $(".kendo-datepicker").each(function () {
                var datepicker = $(this).data("kendoDatePicker");
                if (datepicker) {
                    datepicker.destroy();
                }
            });

            // Reinitialize Kendo UI components with data source
            $(".customer-dropdown").kendoDropDownList({
                dataSource: @Html.Raw(Json.Encode(ViewBag.Customers)),
                dataTextField: "Text",
                dataValueField: "Value",
                value: selectedCustomerID // Set the selected value directly here
            });

            $(".product-dropdown").kendoDropDownList({
                dataSource: @Html.Raw(Json.Encode(ViewBag.Products)),
                dataTextField: "Text",
                dataValueField: "Value"
            });

            $(".kendo-datepicker").kendoDatePicker({
                format: "yyyy-MM-dd"
            });
        }

        // Function to initialize Kendo UI components for new row
        function initializeKendoComponentsForNewRow() {
            var productDropdown = $(".product-dropdown").last().kendoDropDownList({
                dataSource: @Html.Raw(Json.Encode(ViewBag.Products)),
                dataTextField: "Text",
                dataValueField: "Value"
            }).data("kendoDropDownList");

            // Set the default value to the first product in the list
            var firstProduct = productDropdown.dataSource.data()[0];
            if (firstProduct) {
                productDropdown.value(firstProduct.Value);
                productDropdown.trigger("change"); // Trigger change event to update unit price
            }
        }
    });
</script>
